# PPID Spoofing

## What is PPID Spoofing ?

PPID (Parent Process ID) Spoofing is a technique used by red team operators to alter the Parent [Process ID](https://en.wikipedia.org/wiki/Process_identifier) of a process, thereby concealing its true origin or avoiding detection. Typically, a process's [Parent Process](https://en.wikipedia.org/wiki/Parent_process) ID reveals which process initiated it. By modifying this ID, malicious software can impersonate being started by a legitimate process (such as explorer.exe) rather than its actual malicious origin. Hence, PPID Spoofing attacks can be considered as leveraging vulnerabilities in the Kernel Driver.

---

### Purpose and Principle

By default, most programs that require user interaction are launched by explorer.exe. For example, when we create a new text document on the desktop and then open it with Notepad, the process is as shown in the following illustration:

> [Process Explorer](https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer) or [Process Hacker](https://processhacker.sourceforge.io/downloads.php) can be used to observe the relationships between processes in this scenario.

![Untitled](../../assets/PPID-Spoofing/ProcessExplorerExample1.png)

You can clearly see the parent-child relationship: `explorer.exe` -> `Notepad.exe`.

However, with the following code, we can make `Notepad.exe` appear as if it was created by `Discord.exe` (PID: 19100).

```
#define _CRT_SECURE_NO_WARNINGS

#include <windows.h>
#include <TlHelp32.h>
#include <iostream>

int main()
{
    STARTUPINFOEXA si;
    PROCESS_INFORMATION pi;
    SIZE_T attributeSize;
    ZeroMemory(&si, sizeof(STARTUPINFOEXA));

    // To modify the PID here
    HANDLE parentProcessHandle = OpenProcess(MAXIMUM_ALLOWED, false, 19100);

    InitializeProcThreadAttributeList(NULL, 1, 0, &attributeSize);
    si.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST)HeapAlloc(GetProcessHeap(), 0, attributeSize);
    InitializeProcThreadAttributeList(si.lpAttributeList, 1, 0, &attributeSize);
    UpdateProcThreadAttribute(si.lpAttributeList, 0, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, &parentProcessHandle, sizeof(HANDLE), NULL, NULL);
    si.StartupInfo.cb = sizeof(STARTUPINFOEXA);

    CreateProcessA(NULL, (LPSTR)"notepad", NULL, NULL, FALSE, EXTENDED_STARTUPINFO_PRESENT, NULL, NULL, &si.StartupInfo, &pi);

    return 0;
}
```

![Untitled](../../assets/PPID-Spoofing/ProcessExplorerExample2.png)

The key function here is [CreateProcessA](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa).

---

## What is CreateProcessA ?

`CreateProcessA` is generally used to create new processes, and by default, it will use the inherited parent to create the process. For example, if opened through cmd, its parent is cmd. However, this function also supports a parameter called `lpStartupInfo`, where you can customize its parent process.

`[in] lpStartupInfo`

> A pointer to a [STARTUPINFO](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/ns-processthreadsapi-startupinfoa) or [STARTUPINFOEX](https://learn.microsoft.com/en-us/windows/win32/api/winbase/ns-winbase-startupinfoexa) structure.
>
> To set extended attributes, use a STARTUPINFOEX structure and specify EXTENDED_STARTUPINFO_PRESENT in the dwCreationFlags parameter.
>
> Handles in STARTUPINFO or STARTUPINFOEX must be closed with [CloseHandle](https://learn.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle) when they are no longer needed.

The `STARTUPINFOEX` structure contains an `lpAttributeList`.

`lpAttributeList`

> An attribute list. This list is created by the [InitializeProcThreadAttributeList](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist) function.

![image](https://hackmd.io/_uploads/r180hoAuA.png)

> The documentation notes that to add attributes to the list, you need to call the [UpdateProcThreadAttribute](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) function.

An attribute parameter called `Attribute`.
The `PROC_THREAD_ATTRIBUTE_PARENT_PROCESS` attribute is used to set the parent process of a new process.

Use Cobalt Strikeâ€™s Office macro to generate a Word document, and the victim opens the document, it establishes a connection.

> The example shows that there is a rundll32.exe under word.exe.

![Untitled](../../assets/PPID-Spoofing/ProcessExplorerExample3.png)

Therefore, PPID Spoofing is designed to evade detection based on the parent-child process relationship.

---

## Refer

1. [ired.team : Parent Process ID (PPID) Spoofing](https://www.ired.team/offensive-security/defense-evasion/parent-process-id-ppid-spoofing)
2. [Capt. Meelo : Picky PPID Spoofing](https://captmeelo.com/redteam/maldev/2021/11/22/picky-ppid-spoofing.html)
3. [F-Secure : Detecting Parent PID Spoofing](https://blog.f-secure.com/detecting-parent-pid-spoofing/)
